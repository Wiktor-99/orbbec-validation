version: '3.8'

services:
  orbbec-validation:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: orbbec-validation
    privileged: true
    network_mode: host
    devices:
      - "/dev:/dev"
    volumes:
      - /tmp/recordings:/tmp/recordings
      - ./cyclonedds.xml:/var/tmp/cyclonedds.xml
    environment:
      - ROS_DOMAIN_ID=0
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
      - ROS_AUTOMATIC_DISCOVERY_RANGE=LOCALHOST
      - CYCLONEDDS_URI=file:///var/tmp/cyclonedds.xml
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
    runtime: nvidia
    command: >
      bash -c "ros2 launch orbbec_validation_launch orbbec_validation.launch.py recording_path:=/tmp/recordings/run_$(date +%Y%m%d_%H%M%S)"
    restart: unless-stopped
    ulimits:
      nofile:
        soft: 1024
        hard: 2048
